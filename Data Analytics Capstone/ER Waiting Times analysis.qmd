---
title: "Emergency Waiting time Analysis"
format: html
editor: visual
---

## Loading necessary libraries:

```{r}
#| warning: false
#| message: false
#| include: true

library(dplyr)
library(hms)
library(lubridate)
library(tidyverse)

```

## Loading the ER Waiting Times data:

```{r}
#| Warning: false
#| message: false
#| include: true


ERdata <- read.csv("https://raw.githubusercontent.com/Archangelo08/Data-Analytics-SAIT-Projects/refs/heads/main/Data%20Analytics%20Capstone/ER%20Wait%20Time%20Dataset.csv")
```

## Data cleaning and transformations

**Checking for nulls and errors:**

```{r}
#| warning: false
#| message: false
#| include: true

ERdata %>% 
  sapply(function(x) sum(is.na(x)| x == ""))

```

There are no nulls or empty rows found in the Emergency Waiting times data.

**Checking the data types for each variable:**

```{r}
#| warning: false
#| message: false
#| include: true

str(ERdata)

```

The \[Visit Date\] column is assigned with "chr" data type. This should be assigned with the appropriate date-time data type. To do this, first, the date and time components will be separated into two new calculated columns: "Date of visit" and "Time of visit". After, we will remove the \[Visit Date\] column since it will not be used in the succeeding analysis.

```{r}
#| warning: false
#| message: false
#| include: true

ERdata <- ERdata %>% 
  mutate(Visit.Date = as.POSIXct(Visit.Date, format = "%Y-%m-%d %H:%M:%S")) %>% 
  mutate(
    Date_of_visit = as.Date(Visit.Date),
    Time_of_visit = as_hms(Visit.Date)
  ) %>% 
  select(-Visit.Date)
```

After further inspection of the data, we found out that the \[Time of Day\] column does not accurately describe the time of day based on the time value in the \[Time of visit\] column, hence it will be removed. A new calculated column will be created in the succeeding section.

```{r}
#| warning: false
#| message: false
#| include: true

ERdata <- ERdata %>% 
  select(-Time.of.Day)
```

**Changing column names for clarity:**

```{r}
#| warning: false
#| message: false
#| include: true

ERdata <- ERdata %>% 
  rename(
    Available.Beds = Facility.Size..Beds.,
    Time.to.Registration.min = Time.to.Registration..min.,
    Time.to.Triage.min = Time.to.Triage..min.,
    Time.to.Medical.Professional.min = Time.to.Medical.Professional..min.,
    Total.Wait.Time.min = Total.Wait.Time..min.
  )
```

**Added a new column Updated_time_of_day, categorizes each time into Early Morning, Late Morning, Afternoon, Evening and Night.**

*Although this is a good grouping for Time of Day each patient visited the Emergency Department, I think it would be a better idea to group it based on the 3, 24-hour shift of Nurses and Doctors. This would be a better analysis that would give us insights, such as "we saw a significantly longer wait times during Night Shifts". Some of the possible reasons can be: Low Nurse-to-patient ratio.*

```{r}
#| warning: false
#| message: false
#| include: true

ERdata <- ERdata %>%
  mutate(
    hour = hour(Time_of_visit),

    Updated_time_of_day = case_when(
      hour >= 4  & hour < 8  ~ "Early Morning",
      hour >= 8  & hour < 12 ~ "Late Morning",
      hour >= 12 & hour < 17 ~ "Afternoon",
      hour >= 17 & hour < 20 ~ "Evening",
      TRUE ~ "Night"   # 20–23pm and 0–3 (mdnight - am)
    )
  ) %>%
  select(-hour)   # removes temporary hour column

sum(is.na(ERdata$Updated_time_of_day)) # check for NA values


```

Added a new column "Satisfaction_group" that categorizes Patient.Satisfaction scores (1–5) into:

-   Satisfied (4-5)

<!-- -->

-   Neutral (3)

-   Dissatisfied (1-2)

```{r}
#| warning: false
#| message: false
#| include: true
ERdata <- ERdata %>%
  mutate(
    Satisfaction_group = case_when(
      Patient.Satisfaction %in% c(4, 5) ~ "Satisfied",
      Patient.Satisfaction == 3 ~ "Neutral",
      Patient.Satisfaction %in% c(1, 2) ~ "Dissatisfied",
    )
  )
```

Get min and max values for Total.Wait.Time.min

```{r}
#| warning: false
#| message: false
#| include: true
min(ERdata$Total.Wait.Time.min, na.rm = TRUE)
max(ERdata$Total.Wait.Time.min, na.rm = TRUE)
```

Added a new column Waiting_time_group, assigns each patient's total wait time (in minutes) into one of the 6 categories:

-   Very Short Wait (4–14)

-   Short Wait (15–29)

-   Moderate Wait (30–59)

-   Long Wait (60–119)

-   Very Long Wait (120–239)

-   Excessive Wait (240–442)

    ```{r}
    #| warning: false
    #| message: false
    #| include: true

    ERdata <- ERdata %>%
      mutate(
        Waiting_time_group = case_when(
          Total.Wait.Time.min >= 4   & Total.Wait.Time.min <= 14  ~ "Very Short Wait",
          Total.Wait.Time.min >= 15  & Total.Wait.Time.min <= 29  ~ "Short Wait",
          Total.Wait.Time.min >= 30  & Total.Wait.Time.min <= 59  ~ "Moderate Wait",
          Total.Wait.Time.min >= 60  & Total.Wait.Time.min <= 119 ~ "Long Wait",
          Total.Wait.Time.min >= 120 & Total.Wait.Time.min <= 239 ~ "Very Long Wait",
          Total.Wait.Time.min >= 240 & Total.Wait.Time.min <= 442 ~ "Excessive Wait",
          TRUE ~ NA_character_   # fallback if something is outside expected range
        )
      )
    ```

## Exploratory Data Analysis

In this section, distribution of the different features will be explored and relationships between them will be uncovered.

**Distribution of Hospitals by Region**

```{r}
#| warning: false
#| message: false
#| include: true

ERdata %>% 
  group_by(Region) %>% 
  summarize(No_of_hospitals = n_distinct(Hospital.Name)) %>% 
  ggplot(aes(Region,No_of_hospitals)) +
  geom_col() +
  labs(
    title = "Number of Hospitals by Region",
    x = ""
  ) +
  theme_minimal()
  
```

This data is being represented by 2 hospitals in the Rural region and 3 in the Urban region.

**Number of Patients by Season**

```{r}
#| warning: false
#| message: false
#| include: true

ERdata %>% 
  group_by(Season) %>% 
  summarize(No_of_patients = n()) %>% 
  ggplot(aes(reorder(Season, No_of_patients), No_of_patients)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Distribution of patients by Season",
    x = "",
    y = "Number of Patients"
  ) +
  theme_minimal()
```

In terms of Season, we see more patients visiting the Emergency department in Summer, followed by Winter, Fall, and Spring.

**Number of Patients by Urgency Level**

```{r}
#| warning: false
#| message: false
#| include: true

ERdata %>% 
  group_by(Urgency.Level) %>% 
  summarize(No_of_patients = n()) %>% 
  ggplot(aes(reorder(Urgency.Level, No_of_patients), No_of_patients)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Distribution of Patients by Urgency Level",
    x = "Urgency Level",
    y = ""
  ) +
  theme_minimal()
```

**Distribution of Patients by Staff Shift**

```{r}
#| warning: false
#| message: false
#| include: true


ERdata %>% 
  group_by(Time_of_Day) %>% 
  summarize(No_of_patients = n()) %>% 
  ggplot(aes(Time_of_Day, No_of_patients)) +
  geom_col() +
  labs(
    title = "Distribution of Patients by Shift",
    x = "Shift",
    y = ""
  ) +
  theme_minimal()
```

## Finding the best regression model

**Convert categorical variables to factors**

*Factors should be applied when creating the regression model.*

```{r}
#| warning: false
#| message: false
#| include: true
#| 
ERdata <- ERdata %>%
  mutate(
    Region = factor(Region),
    Season = factor(Season),
    Day.of.Week = factor(Day.of.Week),
    Updated_time_of_day = factor(Updated_time_of_day)
  )

```

**Creating a multiple regression model including all predictor variables**

```{r}
model_full <- lm(
  Total.Wait.Time.min ~ 
    Nurse.to.Patient.Ratio +
    Specialist.Availability +
    Available.Beds +
    Region +
    Season +
    Day.of.Week +
    Updated_time_of_day,
  data = ERdata
)

```

**Stepwise regression, Backward/Forward combined (direction = "both")**

```{r}
model_step <- step(
  model_full,
  direction = "both",
  trace = TRUE    # FALSE if don't want to trace/see each step
)

summary(model_step) # view final model
model_step$call # view which predictors were kept

```
